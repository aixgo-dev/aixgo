name: Deploy to Cloud Run

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Image tag to deploy (default: latest commit SHA)'
        required: false
        type: string
  push:
    branches:
      - main
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'docker/**'
      - 'deploy/cloudrun/**'
      - '.github/workflows/deploy-cloudrun.yml'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  SERVICE_NAME: aixgo-mcp
  REGISTRY: ${{ secrets.GCP_REGION || 'us-central1' }}-docker.pkg.dev

jobs:
  build:
    name: Build and Push Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Determine image tag
      id: tag
      run: |
        if [ -n "${{ github.event.inputs.image_tag }}" ]; then
          echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
        else
          echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
        fi

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/aixgo.Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/aixgo/mcp-server:${{ steps.tag.outputs.tag }}
          ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/aixgo/mcp-server:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.event.inputs.environment || 'staging' }}
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Set environment variables
      id: env
      run: |
        ENV="${{ github.event.inputs.environment || 'staging' }}"
        if [ "$ENV" = "production" ]; then
          echo "service_suffix=" >> $GITHUB_OUTPUT
          echo "min_instances=1" >> $GITHUB_OUTPUT
          echo "max_instances=10" >> $GITHUB_OUTPUT
          echo "memory=1Gi" >> $GITHUB_OUTPUT
          echo "cpu=2" >> $GITHUB_OUTPUT
        else
          echo "service_suffix=-staging" >> $GITHUB_OUTPUT
          echo "min_instances=0" >> $GITHUB_OUTPUT
          echo "max_instances=3" >> $GITHUB_OUTPUT
          echo "memory=512Mi" >> $GITHUB_OUTPUT
          echo "cpu=1" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to Cloud Run
      id: deploy
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }}${{ steps.env.outputs.service_suffix }} \
          --image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/aixgo/mcp-server:${{ needs.build.outputs.image_tag }} \
          --platform=managed \
          --region=${{ env.REGION }} \
          --allow-unauthenticated \
          --min-instances=${{ steps.env.outputs.min_instances }} \
          --max-instances=${{ steps.env.outputs.max_instances }} \
          --memory=${{ steps.env.outputs.memory }} \
          --cpu=${{ steps.env.outputs.cpu }} \
          --set-env-vars="ENVIRONMENT=${{ github.event.inputs.environment || 'staging' }}" \
          --set-secrets="XAI_API_KEY=xai-api-key:latest,OPENAI_API_KEY=openai-api-key:latest" \
          --revision-suffix=${{ github.run_number }}

    - name: Get Service URL
      id: url
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }}${{ steps.env.outputs.service_suffix }} \
          --platform=managed \
          --region=${{ env.REGION }} \
          --format='value(status.url)')
        echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT

    - name: Health check
      run: |
        echo "Waiting for service to be ready..."
        sleep 10
        curl -sf "${{ steps.url.outputs.url }}/health" || echo "Health check endpoint not available"

    - name: Create deployment summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY <<EOF
        ## Cloud Run Deployment

        - **Service**: ${{ env.SERVICE_NAME }}${{ steps.env.outputs.service_suffix }}
        - **Environment**: ${{ github.event.inputs.environment || 'staging' }}
        - **Region**: ${{ env.REGION }}
        - **Image**: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/aixgo/mcp-server:${{ needs.build.outputs.image_tag }}
        - **URL**: ${{ steps.url.outputs.url }}
        - **Revision**: ${{ github.run_number }}
        - **Status**: Success

        ### Rollback Instructions
        To rollback to a previous revision:
        \`\`\`bash
        gcloud run services update-traffic ${{ env.SERVICE_NAME }}${{ steps.env.outputs.service_suffix }} \\
          --region=${{ env.REGION }} \\
          --to-revisions=REVISION_NAME=100
        \`\`\`

        List available revisions:
        \`\`\`bash
        gcloud run revisions list --service=${{ env.SERVICE_NAME }}${{ steps.env.outputs.service_suffix }} --region=${{ env.REGION }}
        \`\`\`
        EOF
